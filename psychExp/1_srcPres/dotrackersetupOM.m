function result=dotrackersetupSM(el, sendkey)% USAGE: result=dotrackersetup(el, sendkey)%%		el: Eyelink default values%		sendkey: set to go directly into a particular mode% 				'v', start validation% 				'c', start calibration% 				'd', start driftcorrection% 				13, or el.ENTER_KEY, show 'eye' setup image%% 02-06-01	fwc removed use of global el, as suggest by John Palmer.%				el is now passed as a variable, we also initialize Tracker state bit%				and Eyelink key values in 'initEyelinkdefaults.m'% 15-10-02	fwc	added sendkey variable that allows to go directly into a particular mode%result=-1;if nargin < 1	error( 'USAGE: result=dotrackersetupSM(el [,sendkey])' );end	Eyelink('command', 'heuristic_filter = ON');Eyelink( 'startsetup' );		% start setup modeEyelink( 'WaitForModeReady', el.waitformodereadytime );  % time for mode changeclearcaldisplaySM(el);	% setup_cal_display()key=1;% while key~= 0% 	key=getkeyforEyelink(el);		% dump old keys% end% go directly into a particular modeif nargin==2	if el.allowlocalcontrol==1		switch lower(sendkey)			case{ 'c', 'v', 'd', el.ENTER_KEY}                %forcedkey=BITAND(sendkey(1,1),255);				forcedkey=double(sendkey(1,1));				Eyelink('sendkeybutton', forcedkey, 0, el.KB_PRESS );		end	endendtstart=GetSecs;tickcount=0;stop=0;while stop==0 & bitand(Eyelink( 'currentmode'), el.IN_SETUP_MODE)	i=Eyelink( 'currentmode');		if ~Eyelink( 'isconnected' ) stop=1; break; end;	if bitand(i, el.IN_TARGET_MODE)			% calibrate, validate, etc: show targets		%fprintf ('%s\n', 'dotrackersetup: in targetmodedisplay' );		targetmodedisplaySM(el);			elseif bitand(i, el.IN_IMAGE_MODE)		% display image until we're back		%fprintf ('%s\n', 'dotrackersetup: in imagemodedisplay' );	  	if Eyelink ('imagemodedisplay')==el.TERMINATE_KEY 			result=el.TERMINATE_KEY;	    	return;    % breakout key pressed	  	else			clearcaldisplaySM(el);	% setup_cal_display()		end		end% 	[key, tickcount]=getkeyforEyelink(el, tickcount);		% getkey() HANDLE LOCAL KEY PRESS% 	% 	switch key	% 		case el.TERMINATE_KEY,				% breakout key code% 			result=el.TERMINATE_KEY;% 			return;% 		case { 0, el.JUNK_KEY }          % No or uninterpretable key% 		case el.ESC_KEY,% 			if Eyelink('isconnected') == el.dummyconnected% 				stop=1; % instead of 'goto exit'% 			end% 		    if el.allowlocalcontrol==1% 	       		Eyelink('sendkeybutton', key, 0, el.KB_PRESS );% 			end% 		otherwise, 		% Echo to tracker for remote control% 		    if el.allowlocalcontrol==1% 	       		Eyelink('sendkeybutton', key, 0, el.KB_PRESS );% 			end% 	endend % while IN_SETUP_MODE% exit:clearcaldisplaySM(el);	% exit_cal_display()result=0;return;	